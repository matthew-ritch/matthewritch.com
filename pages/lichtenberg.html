---
permalink: /fun/lichtenberg/
---
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Lichtenberg- Click Around!</title>
    <meta name="viewport" content="width=device-width, height=device-height initial-scale=1">
    <style>html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; } canvas { display: block; }</style>
</head>
<body>
<canvas id="lichtenberg"></canvas>
<script>
    var width  = Math.floor(window.innerWidth);
    var height = Math.floor(window.innerHeight);
    var rows   = 200;
    var cols   = Math.round(rows * width / height);
    var pbase  = 0.27;
    var pFact  = 0.8;

    var cellW = width  / cols;
    var cellH = height / rows;

    var canvas = document.getElementById('lichtenberg');
    canvas.width  = width;
    canvas.height = height;
    var ctx = canvas.getContext('2d');

    // Typed arrays: p values and cell state (1=intact, 0=done, 3=queued)
    var p     = new Float32Array(rows * cols);
    var state = new Uint8Array(rows * cols);
    var pmax  = pbase + 0.1 * (1 - pbase);

    for (var i = 0; i < rows * cols; i++) {
        p[i]     = pbase + pFact * (1 - pbase) * Math.random();
        state[i] = 1;
    }

    // Initial render via ImageData (single GPU upload)
    var imgData = ctx.createImageData(width, height);
    var px = imgData.data;
    for (var r = 0; r < rows; r++) {
        var canvasY0 = Math.floor((rows - 1 - r) * cellH);
        var canvasY1 = Math.floor((rows - r) * cellH);
        for (var c = 0; c < cols; c++) {
            var v = Math.round(255 * (1 - Math.min(1, p[r * cols + c] / pmax)));
            var x0 = Math.floor(c * cellW);
            var x1 = Math.floor((c + 1) * cellW);
            for (var py = canvasY0; py < canvasY1; py++) {
                for (var pxi = x0; pxi < x1; pxi++) {
                    var pi = (py * width + pxi) * 4;
                    px[pi] = px[pi+1] = px[pi+2] = v;
                    px[pi+3] = 255;
                }
            }
        }
    }
    ctx.putImageData(imgData, 0, 0);

    function fillCell(row, col, r, g, b) {
        ctx.fillStyle = 'rgb(' + r + ',' + g + ',' + b + ')';
        ctx.fillRect(Math.floor(col * cellW), Math.floor((rows - 1 - row) * cellH),
                     Math.ceil(cellW), Math.ceil(cellH));
    }

    const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

    async function start_evolve(event) {
        var ex   = event.clientX;
        var ey   = event.clientY;
        var row  = 1 + rows - Math.round(ey / (height / rows));
        var col  = -2 + Math.round(ex / (width / cols));
        var ind  = row * cols + col;

        state[ind] = 0;
        fillCell(row, col, 255, 255, 255);

        var actives    = [ind];
        var possibles  = [];
        var newActives = [];

        while (actives.length > 0) {
            possibles.length = 0;

            for (var i = 0; i < actives.length; i++) {
                var act = actives[i];
                var ar  = Math.floor(act / cols);
                var ac  = act % cols;
                var neighbors = [ar * cols + ac - 1, ar * cols + ac + 1,
                                 (ar - 1) * cols + ac, (ar + 1) * cols + ac];
                for (var n = 0; n < 4; n++) {
                    var ni = neighbors[n];
                    if (ni >= 0 && ni < rows * cols && state[ni] === 1) {
                        state[ni] = 3;
                        possibles.push(ni);
                    }
                }
            }

            newActives.length = 0;
            for (var i = 0; i < possibles.length; i++) {
                var ni  = possibles[i];
                var nr  = Math.floor(ni / cols);
                var nc  = ni % cols;
                state[ni] = 0;
                if (Math.random() < p[ni]) {
                    fillCell(nr, nc, 255, 255, 255);
                    newActives.push(ni);
                } else {
                    fillCell(nr, nc, 75, 0, 130); // indigo
                }
            }

            actives = newActives.slice();
            await delay(1);
        }
    }

    document.addEventListener('click', start_evolve);
</script>
</body>
</html>